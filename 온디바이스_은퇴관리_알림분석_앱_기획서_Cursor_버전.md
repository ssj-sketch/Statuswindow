# 온디바이스 자산·은퇴관리 앱 기획서 (알림 분석 기반) — **Cursor AI 코딩 버전**

> **목표**: 스마트폰의 **알림(Notification)**만으로 은행·카드·증권·메신저·문자 정보를 **온디바이스에서 안전하게 분석**하여, 최소 입력으로 **수입·지출·순자산**을 추정하고 **은퇴자산 시뮬레이션**을 제공하는 안드로이드 앱.  
> **개발 방식**: **Cursor** 중심의 AI 페어프로그래밍(테스트 주도·스펙 우선).  
> **레퍼런스 앱**: [Notisave (알림 수집 UX)](https://play.google.com/store/apps/details?id=com.tenqube.notisave&hl=ko)

---

## 1) 제품 비전 & 가치 제안
- **무계정·무로그인·무서버**: 네트워크가 없어도(비행기 모드 포함) 핵심 기능 100% 동작.
- **최소 입력**: 알림 파싱으로 자동 계정/거래 추정. 필요 시만 보정 입력.
- **프라이버시 우선**: 모든 데이터 **로컬 암호화 저장**, 외부 전송 차단(옵트인 온라인 갱신만 예외).
- **즉시 효용**: 알림 수신 시 **소비/저축/은퇴잔고 영향**을 실시간 가시화.
- **글로벌 대응**: 10개 언어, 각 국가의 **통화·포맷·연금/세제 규칙**을 **프로필 모듈**로 분리.

---

## 2) Cursor 기반 개발 원칙
1. **Spec-First**: 기능/API/데이터모델을 Markdown 스펙으로 정의 → Cursor로 코드 스캐폴딩 생성.
2. **TDD**: 유즈케이스별 테스트 작성 → 실패 → 최소 구현 → 통과 → 리팩터.
3. **Prompt 템플릿화**: 파서 정규식/NER, Room 스키마, Compose 컴포넌트, 애니메이션 등을 재사용 프롬프트로 보관.
4. **Inline Review**: PR 템플릿 + Cursor 코드리뷰 요청 프롬프트로 일관 품질 확보.
5. **Docs-as-Code**: 이 문서와 스키마/다이어그램을 리포지토리에 함께 버전관리.

**Cursor 프롬프트 예시(요약)**  
- *“다음 스펙에 맞춰 NotificationListenerService와 Room 엔티티/DAO 코드를 생성. Kotlin, minSdk 26, Jetpack Compose. TDD: junit5, mockk. 보안: EncryptedSharedPreferences/Room + Android Keystore.”*

---

## 3) 핵심 사용자 시나리오
1. **초기 실행**: 알림 접근 권한 허용 → 최근 알림 스캔 → **계정·카드·거래** 후보 자동 생성.
2. **대시보드**: 오늘/월간 지출, 예상 수입, 추정 순자산, 은퇴 시뮬레이션(목표/진척).
3. **알림 수신 시**: 파싱 → 거래 반영 → **은퇴자금 그래프가 드라마틱하게 변화**(애니메이션).
4. **오프라인**: 비행기 모드에서도 파싱·집계·시각화 정상 동작.
5. **온라인(옵트인)**: **주택공시가격, 주식 현재가, 환율** 업데이트.

---

## 4) 기능 요구사항 (요약)
- **데이터 수집**: Android `NotificationListenerService`로 알림 캡처(SMS/메신저/은행/카드/증권).
- **파싱 & 정규화**: 브랜드/채널별 템플릿 & 정규식 + 경량 ML(TFLite)로 **금액·통화·카테고리** 식별.
- **지식 그래프**: 카드↔은행계좌↔사용자 계정 매핑, 상점/가맹점 카테고리.
- **오프라인 엔진**: 로컬 DB + 가격/지수 캐시로 **순자산/은퇴 시뮬**.
- **온라인 업데이트(선택)**: 공시가/주식/환율/물가 지표 캐시 갱신(사용자 동의 후).
- **다국어/다국가**: 10개 언어, 국가별 **프로필(통화/포맷/연금규칙/세율/소비세)**.
- **자동 국가·언어 선택**: 시스템 설정 자동 감지(수동 변경 가능).
- **레퍼런스**: Notisave의 **알림 수집·검색 UX 흐름** 참고.

---

## 5) 기술 아키텍처
```
App (Android, Kotlin, Compose)
├─ UI 레이어
│  ├─ 대시보드·리포트·설정·튜토리얼
│  └─ 애니메이션(은퇴잔고 변동, 스프링 이징)
├─ 도메인 레이어
│  ├─ 트랜잭션 엔진(수입/지출/자산 집계)
│  ├─ 은퇴 시뮬레이션(목표/확률/시나리오/4% 규칙)
│  ├─ 분류기(룰+경량 ML/TFLite)
│  └─ 국가 프로필(연금/세제/통화/포맷)
├─ 데이터 레이어
│  ├─ 알림 수집(NotificationListenerService)
│  ├─ 파서(템플릿/정규식/NER)
│  ├─ 로컬 DB(Room + AES/Keystore)
│  └─ 캐시(가격·환율·공시가격; 오프라인 우선)
└─ 시스템
   ├─ 권한/프라이버시
   ├─ 백그라운드(WorkManager)
   └─ 암호화/백업(로컬 전용)
```

---

## 6) 데이터 파이프라인
1. **수집**: 알림 메타(패키지/채널/시간/제목/본문/액션) 저장.
2. **전처리**: 언어·국가 감지 → 숫자/통화 토큰화 → 상점명 정규화.
3. **파싱**: 정규식 템플릿 + (옵션) TFLite NER → 금액/통화/상호/카테고리 추출.
4. **정규화**: 통화/부호(지출=음수), 카테고리 매핑(ISO/내부 코드).
5. **저장**: `transactions`, `accounts`, `positions`, `prices`, `country_profile`.
6. **집계**: 일/월/연 지출, 순자산, 저축률, **은퇴 목표 대비 격차** 계산.
7. **시각화**: 대시보드·타임라인·예측그래프·예산바.
8. **이벤트**: 새 알림 반영 시 **은퇴잔고 애니메이션** 트리거.

---

## 7) 로컬 데이터 모델(예시)
- `accounts(id, type[checking/card/securities/loan], currency, issuer, masked_no)`  
- `transactions(id, account_id, ts, amount, currency, merchant, category, raw_text, hash)`  
- `positions(id, asset_type[cash/stock/property/fund], symbol, qty, currency)`  
- `prices(symbol, currency, price, asof)`  
- `country_profile(code, currency, locale, pension_rules_json, tax_params_json)`  
- `user_prefs(lang, country, risk_level, target_retire_age, target_income)`  
**무결성**: `hash`로 중복 방지, 취소/정정 상호 참조.

---

## 8) 오프라인 우선 동작
- **로그인 불필요**, 모든 연산/저장 로컬.
- **암호화 저장**: Android Keystore 마스터키, Room(AES-GCM) 암호화.
- **백업 차단**: OS 기본 백업 비활성(민감 데이터 보호).
- **캐시 만료**: 주식/환율/공시가 유효기간 내 로컬 사용.
- **업데이트 큐**: 온라인 감지 시 **사용자 동의 후** 일괄 업데이트(WorkManager).

---

## 9) 온라인(선택) 데이터 소스
- **주택공시가격**: 국가별 API 어댑터(캐시·레이트 리밋).
- **주식/지수/환율**: 공급자 추상화(복수 프로바이더, 폴백).
- **물가/연금 계수**: 연 1~2회 정책 갱신(동의 후 로컬 반영).
> 모든 외부 통신은 **명시적 옵트인**, **프록시/서버 미사용**(직접 호출).

---

## 10) 은퇴 시뮬레이션(온디바이스)
- **입력(자동/최소 보정)**: 월평균 순지출, 저축률, 현재 순자산, 연금/퇴직연금 추정.
- **모델**:
  - 규칙 기반: 4% 규칙, `목표자산 = (목표연간지출 - 연금수입) × 계수`.
  - 시나리오: 보수/중립/공격적 실질수익률, 인플레이션 가정.
  - (옵션) 경량 몬테카를로(리소스 한계 시 샘플 축소).
- **출력**: 목표 도달 확률, 예상 은퇴 연령, 안전지출 한도, **소비 이벤트 영향도**.

---

## 11) 드라마틱 애니메이션 사양
- **트리거**: `transactions` upsert 완료 시.
- **효과**: 은퇴잔고 그래프 **스프링 이징**으로 ±Δ만큼 튐 → 감쇠.
- **카피**: “이번 지출로 은퇴가능연령이 **+12일** 늦어졌어요”, “이번 저축으로 **-8일** 빨라졌어요”
- **접근성**: 강도/시간 조절, 저시력 모드 고대비.

---

## 12) 다국어/다국가 전략
- **언어(10)**: ko, en, ja, zh-Hans, zh-Hant, es, fr, de, id, vi, th.
- **국가 프로필**: 통화·날짜/숫자 포맷, VAT/소득세 요약, 공적연금 파라미터.
- **자동 선택**: `Locale.getDefault()` + `TelephonyManager` 국가 코드.
- **번역 품질**: ICU 메시지, 복수형/성별/단위 처리, 현지화 회귀 테스트.

---

## 13) 권한·보안·정책
- **권한(필수)**: `BIND_NOTIFICATION_LISTENER_SERVICE` (알림 접근).  
  *(SMS 읽기 권한은 정책 리스크 때문에 기본 미사용 권장)*
- **민감 데이터 고지**: 수집 범위/목적/오프라인 처리/암호화 명시, 옵트아웃 용이.
- **Play 정책**: 사용자 데이터·백그라운드 제한 준수, 접근성 서비스 미사용.
- **로그**: 민감값 비기록, 크래시 리포트도 PII 제거/옵션화.

---

## 14) 파서 설계(정규식 예시)
- **카드 승인**:  
  `(?P<card>...)\s*승인\s*(?P<amount>[0-9,]+)\s*(?P<ccy>KRW|원)\s*(?P<merchant>.+?)\s*(?P<time>\d{2}:\d{2})`
- **계좌 입출금**: `입금|출금`, `잔액`, 국가 계좌 포맷 인식(국내/IBAN).
- **증권 체결**: `매수|매도`, 종목/수량/단가/수수료, 체결시간.
- **신뢰도**: 파싱 신뢰도 < 0.7 → “확인 필요” 라벨 및 사용자 수정 플로우.

---

## 15) 개발 로드맵 (요청하신 순서 반영)
1. **데이터 수집** → 알림 Listener, 저장, 중복제거, 신뢰도 점수.
2. **수집데이터 보기** → 타임라인/필터/검색, 원문-파싱 매핑 UI.
3. **의미있는 데이터 분석** → 카테고리 분류, 계정/자산 매핑, 월간 집계.
4. **데이터 시각화** → 대시보드/리포트/시뮬/애니메이션 샘플.
5. **소비 알림 수신 시 은퇴자금 변동 애니메이션** → 키프레임/스프링 이징/카피.
6. **온라인 업데이트(선택)** → 공시가/주식/환율 캐시 & 동기화.
7. **다국어/다국가** → 10개 언어, 국가 프로필, 현지 QA.
8. **정책/배포** → 개인정보 고지/정책, 스토어 메타, 성능·배터리 최적화.

---

## 16) Cursor 워크플로우 & 저장소 규칙
- **브랜치 전략**: `main`(보호) / `develop` / `feature/*` / `hotfix/*`
- **커밋 규칙**: Conventional Commits (`feat:`, `fix:`, `chore:` …)
- **PR 템플릿(요약)**:
  - 목적/배경, 구현 요약, 테스트 항목, 스크린샷/영상, 보안/정책 체크리스트
- **자동화**: Gradle Lint, ktlint, detekt, unit test CI, 번역 키 누락 검사.
- **지식베이스**: `/docs/prompts/`에 Cursor 프롬프트, 룰/정규식 카탈로그 버전관리.

---

## 17) 테스트 & 품질
- **단위/통합**: 파서, 분류기, 시뮬 레이어(junit5, mockk).
- **시뮬 알림 팩**: 5k 가짜 알림(은행/카드/증권/메신저), 다국어 포함.
- **현지화 테스트**: 스냅샷 회귀, 숫자/통화/날짜 포맷 케이스.
- **보안 점검**: 키 관리/암호화 검증, 로그 민감도 검사.
- **퍼포먼스**: 파싱 < 80ms, cold start < 1.5s, 배터리 영향 측정.

---

## 18) KPI
- 온보딩 완료율, D7 활성률, 알림→거래 매칭 정밀도/재현율, 수정 빈도, 은퇴목표 설정률, 온라인 업데이트 옵트인율.

---

## 19) 리스크 & 대응
- **템플릿 변화**: 로컬 룰 업데이트 어려움 → **커뮤니티 규칙 공유(수동 import/export)**, 정규식 오토제너레이터 도구.
- **정책 변경**: 알림 접근/권한 정책 변화 대비 대체 경로 연구.
- **다국가 복잡성**: 국가 프로필 모듈화, 단계적 롤아웃.

---

## 20) 기술 스택(안드로이드 예시)
- Kotlin, Jetpack Compose, Room(Encrypted), WorkManager, AndroidX Security, TFLite(옵션), MPAndroidChart/Compose Charts.
- Min SDK 26+, Target 최신.
- 빌드/품질: Gradle, ktlint, detekt, junit5, mockk, GitHub Actions.

---

## 21) 파일/패키지 구조(예시)
```
app/
├─ data/
│  ├─ db/ (Room entities, DAO)
│  ├─ parser/ (regex, templates, NER)
│  └─ repo/
├─ domain/
│  ├─ model/ (Transaction, Account, Position, CountryProfile ...)
│  ├─ usecase/ (AggregateSpending, RunRetireSim ...)
│  └─ rules/ (PensionRules per country)
├─ ui/
│  ├─ dashboard/, timeline/, report/, sim/, settings/
│  └─ components/ (charts, cards, animations)
└─ system/ (security, work, locale, permissions)
```
